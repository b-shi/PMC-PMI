# PMC-PMI

PMC-PMI is a linux kernel module which uses performance monitoring interrupts(PMI) to record performance counter events each cpu cycle. This is one method to observe some of the microarchitectural behaviours of the underlying hardware. The idea was inspired by the wonderfully written blog post https://gamozolabs.github.io/metrology/2019/08/19/sushi_roll.html. For a summary of the main ideas please read the the blog post.  

**DISCLAIMER**: This kernel module has had very limited testing and may contain bugs that I may not be aware of. You are proceeding at your own risk when running it.

## Initial Configuration
Before running the kernel it is recommended to do the following:
* Disable Hyper-Threading in BIOS or possibly via kernel boot parameter
* Enable X2APIC in BIOS
* Using the kernel boot parameter "isolcpus" to isolate cpus you plan to run the module on

##  Building / Getting started
To build the kernel module run

```shell
git clone https://github.com/bsghost/PMC-PMI.git
cd PMC-PMI && make
```

In general to measure the PMC for a given code the steps consists of the following:

```shell
make
./run cpu_num
./parse pmc_pmi-data.log
python ./plot.py
```

##  Highlevel Description


##  Description: pmc_pmi.c, defs_utils.h -> pmc_pmi.ko

##  Description: disable_nmi_watchdog.sh
This script disables various kernel watchdogs which affects PMC values or pollutes dmesg with warning messages.

##  Description: extract_code.sh
Extracts the test code from a dissassembly of the kernel module.

##  Description: log_read.c -> parse
This is a utility for parsing the data dumped by the LKM and collecting various useful statistics. It also generates a file "stripped_for_plotting.txt" which is used by plot.py for generating the plots.

##  Description: plot.py
Reads the input file "stripped_for_plotting.txt" generated by the parser above and graphs the data. Options:
* -x: Maximum Number of Cycles to plot
* -y: Maximum y range in the graph
* -l: List of labels for the perf counters, comma delimited. (PMCi is used if nothing provided)

##  Description: Examples

##  Support
* Intel CPUs only
* X2APIC must be enabled
* The LKM tries to support performance monitoring arch 3 and 4

## Links
Sushi-Roll Kernel: https://gamozolabs.github.io/metrology/2019/08/19/sushi_roll.html
Intel SDM: https://software.intel.com/en-us/articles/intel-sdm
Agner Fog Optimization Manuals: https://www.agner.org/optimize/
Good Microarchitecture and Microbenchmarking Articles: http://blog.stuffedcow.net/
Awesome Q&A: https://stackoverflow.com/

## Licensing
TODO
